<!DOCTYPE html>
<html>
    <head>
        <title> Mobiles Lageinformationssystem des Campus der Ruhr-Universität Bochum</title>
		<meta name="Bearbeiter" content="Kai Christopher Rudolph">
        <meta charset="utf-8" />
		
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"  />
		<meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
		
		
		<script src="js/leaflet.js"></script>
		<script src="js/deps.js"></script>
		<script src="js/leaflet-include.js"></script>
		<script src="dist/leaflet-routing-machine.js"></script>
		<script src="dist/lrm-mapzen.js"></script>
		<script src="dist/lrm-valhalla.js"></script>
		<script src="dist/Control.Geocoder.js"></script>
		<script src="dist/leaflet.awesome-markers.js"></script>
		<script src="js/leaflet-search.js"></script>
		<script src="js/easy-button.js"></script>
		<script src="js/L.Control.Locate.js" ></script>
		<script src="js/L.Control.Sidebar.js"></script>
        <script src="js/label.js"></script>
        <script src="js/Autolinker.min.js"></script>
		<script src="js/easy-button.js"></script>
		<script src="js/Control.Loading.js"></script>
		<script src="js/bouncemarker.js"></script>
		<script src="js/leaflet.ajax.js"></script>
		<script src="js/L.Control.Sidebar.js"></script>
		<script src="js/spin.js" charset="utf-8"></script>
		<script src="js/leaflet.spin.js" charset="utf-8"></script>
		<script src="js/Leaflet.ImageOverlay.Rotated.js"></script>


		<script src="data/json_Alle.js"></script>
		<script src="data/rahmen1.js"></script>
		

		<link rel="stylesheet" href="font-awesome-4.7.0/css/font-awesome.min.css" />
		<link rel="stylesheet" href="css/leaflet.css" />
		<link rel="stylesheet" href="dist/leaflet-routing-machine.css" />
		<link rel="stylesheet" href="css/L.Control.Locate.css" />
        <link rel="stylesheet" type="text/css" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/label.css" />
		<link rel="stylesheet" href="css/mobile.css" />
		<link rel="stylesheet" href="css/easy-button.css" />
		<link rel="stylesheet" href="css/Control.Loading.css" />
		<link rel="stylesheet" href="dist/leaflet.awesome-markers.css" />
		<link rel="stylesheet" href="css/L.Control.Sidebar.css" />
		<link rel="stylesheet" href="css/leaflet-search.css" />	

		
	    <style>
        body {
		
            padding: 0;
            margin: 0;
        }

        html, body, #map {

			background-color: black;
			background-opacity: 0.0;
        }

		
		 #sidebar {	
		 
			font-family: droid-sans, sans-serif;
			
        }
		
	
    </style>
	
	</head>
    <body>
	    <div id="sidebar"></div>
		<div id="map"></div>

        <script>
					
//Einrichtung des Karte-Containers
var map = L.map('map', {
	zoomControl: false,
	rotate: true,
	touchRotate: false,
	maxZoom: 17,
	minZoom: 15,
	center: [51.44480, 7.26150],
	bounceAtZoomLimits: false
	})
	.setView([51.44480, 7.26150], 17);

//Einrichtung der Basiskarte
var osmUrl = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
	osmAttrib = '&copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap</a> contributors',
	osm = L.tileLayer(osmUrl, {
	maxZoom: 17,
	minZoom: 15,
	bounceAtZoomLimits: false
	});
	
	
//Drehung des Kartencontainers um Winkel 28.224 Grad		
var angle = 28.224;
	map.setBearing(angle);	

	
//Ladespinner beim Start der Anwendung	
map.spin(true), setTimeout(function(){
	map.spin(false);
	},1000)
		
		
//Einrichtung der Campuskarte im Rasterformat
var CampusMapLinear = L.tileLayer('http://kairud.111mb.de/MB_Campus/MB_Campus/{z}/{x}/{y}.png',{
	maxZoom: 17,
	minZoom: 1,						//raus zoomen
	center: [51.44480, 7.26150],
	//detectRetina: true,
	//zoomSnap:0.1,
	bounceAtZoomLimits: false,
	attribution: "RUB-Campusplan &copy; <a href='https://www.geographie.ruhr-uni-bochum.de/institut/'>AG Geomatik | Geographisches Institut</a>"
});
		


//Einrichtung einer LayerGroup für mapOverlays
var polygone = new L.layerGroup();

		
//Inhalt für mapOverlays implementieren
var overlayMaps = {
	"<img src= css/images/Fig._28_-_Divieto_di_transit_nei_due_sensi_-_1959.svg height=25> Sperrungen": CampusMapLinear,
	"<img src= css/images/WBW-Logo_Sommer.svg height=25> Sommerfest": polygone
};
	
//mapOverlays-Control der Karte hinzufügen
myControl = L.control.layers(null, overlayMaps, {position: "bottomleft"})
	.addTo(map);
	
	
//Beim Zoomstart die SVG-Datei ausblenden und die Rasterdatei einblenden, bei Zoomende SVG-Datei einblenden und Rasterdatei ausblenden	
map.on("zoomstart", function(){
	overlay.setOpacity(0.0);
	map.addLayer(CampusMapLinear);
});

map.on("zoomend", function(){
	map.spin(true),
	setTimeout(function() {
	map.removeLayer(CampusMapLinear);
	overlay.setOpacity(1);
	map.spin(false);
	}, 100)
});

//LocalStorage der Alarmmeldungen auf Null setzen	
localStorage.removeItem('alerted');
localStorage.removeItem('alerted1');
			

//Marker und entsprechende Icons für die Routing-Schaltflächen einrichten
var WalkMarker = L.AwesomeMarkers.icon({
    icon: 'fa-male',
	prefix: 'fa',
    markerColor: 'orange',
});
  
var CarMarker = L.AwesomeMarkers.icon({
    icon: 'fa-car',
	prefix: 'fa',
    markerColor: 'orange',
});


//Marker und entsprechende Icons für die Routing-Funktion einrichten
var markerStart = L.AwesomeMarkers.icon({
	icon: 'fa-circle-o',
	prefix: 'fa',
    markerColor: 'orange'
});
  
var markerZiel = L.AwesomeMarkers.icon({
    icon: 'fa-flag',
	prefix: 'fa',
    markerColor: 'orange',
	iconColor: 'black'
});
		
		
//Popups für die Routing-Marker erstellen	
var popupStart = L.popup()
	.setContent("Zieh mich an Deinen Startpunkt !");
		
var popupZiel = L.popup()
	.setContent("Zieh mich an Deinen Zielpunkt !");
		
			
//Koordinaten der Routing-Marker zur bei Start der Funktion festlegen
var Start = L.latLng(51.44499, 7.26078);	
var Ziel = L.latLng(51.44375, 7.26185);

//Routing-Control implementieren
var controlRouting = L.Routing.control({
	lineOptions: {
    styles: [
             {color: 'white', opacity: 0.9, weight: 9},
             {color: '#FC8428', opacity: 1, weight: 3}
            ]
     },
	waypoints: [
				Start,
				Ziel
				],
	createMarker: function (i, waypoint, n){ 
    var marker = L.marker (waypoint.latLng, {
                draggable: true,
                icon: WalkMarker
    })
    if (i == 0) {
        marker.setIcon(markerStart).bindPopup(popupStart)
    } else if (i == n -1) {
        marker.setIcon(markerZiel).bindPopup(popupZiel)
    }
    return marker
	},
	fitSelectedRoutes: false,
	router: L.Routing.mapzen('mapzen-m7c1Upx', {
    costing: "",
	  directions_options: {
							language: 'de',
						  }
	  }),	
	  formatter: new L.Routing.mapzenFormatter(),
	  reverseWaypoints: true
});

	
//Sidebar einrichten
var sidebar = L.control.sidebar('sidebar', {
    closeButton: true,
    position: 'right'
});

//Sidebar hinzufügen und ausblenden   
map.addControl(sidebar);
sidebar.hide();
		
		
//PopUp-Inhalt definieren, an Sidebar übergeben und Sidebar über click-event auf ein feature öffnen
function pop_Alle(feature, layer) {
	layer.on('click', function (e) {
			layer.bringToFront();
			json_AlleJSON.setStyle({fillColor: 'grey', color: 'black'});
			layer.setStyle({radius: 8.0, fillColor: '#EEC900', color: 'black', weight: 1.5});		
			var sidebarContent = 
			
			'<table><tr><th scope="row">Bezeichnung</th><td>' + Autolinker.link(String(feature.properties['Bez'])) + '</td></tr><tr><th scope="row">Öffnungszeiten</th><td>' + Autolinker.link(String(feature.properties['NAME'])) + '</td></tr><tr><th scope="row">Telefon/Mobil</th><td>' + Autolinker.link(String(feature.properties['TELEFON'])) + '</td></tr><tr><th scope="row">Internetadresse</th><td>' + Autolinker.link(String(feature.properties['WWW'])) + '</td></tr><tr><th scope="row">E-Mail</th><td>' + Autolinker.link(String(feature.properties['EMAIL'])) + '</td></tr><tr><th scope="row">Hinweis</th><td>' + Autolinker.link(String(feature.properties['BEMERKUNG'])) + '';

			document.getElementById("sidebar").innerHTML = sidebarContent;
			sidebar.show();
    })
};
		
//Style der Punktsignaturen, die die features des Layers (in dem Fall Alle_json) abbilden -->  Farbe, Radius, Transperanz der Kreise etc.
function doStyleAlle() {
    return {
            radius: 0.0,
            fillColor: 'grey',
            color: 'black',
            weight: 0.0,
            opacity: 1,
            dashArray: '',
            fillOpacity: 1
            }
};
		
//Funktion über die alle features des Layers auf Basis des festlegeten Styles (doStyleAlle) abbgebilded werden
function doPointToLayerAlle(feature, latlng) {
    return L.circleMarker(latlng, doStyleAlle())
};
	

//Einbindung der Datei json_AlleJSON als Layer
var json_AlleJSON = new L.GeoJSON.AJAX("https://raw.githubusercontent.com/kaio328/Application/master/www/data/json_Alle.geojson", {
	onEachFeature: pop_Alle,													
	pointToLayer: doPointToLayerAlle
});

json_AlleJSON.on('data:progress', function (e) {
    if (e.error) {
			var json_AlleJSON = new L.geoJson(json_Alle, {
			onEachFeature: pop_Alle,													
			pointToLayer: doPointToLayerAlle											
			});	
    }
});
//Einbindung der Datei json_AlleJSON als Layer
//Einbindung der Datei json_AlleJSON als Layer
//Einbindung der Datei json_AlleJSON als Layer
//Einbindung der Datei json_AlleJSON als Layer
//Einbindung der Datei json_AlleJSON als Layer

//Inhalt der mapOverlays festlegen
var styleRahmen = {
	"color": 'rgb(0, 0, 1)',
	"weight": 2.5,
	"opacity": 1,
	"fillOpacity": 0
	};
json_rahmenJSON = new L.geoJson(json_rahmen1, {interactive: false, style: styleRahmen}).addTo(polygone);
		
		
//Einrichtung der Suchmaske
//Zunächst Möglichkeit schaffen, nach mehreren Attributen zu suchen
L.Control.Search.include({
		_searchInLayer: function(layer, retRecords, propName) {
			var that = this,
          loc;

		if (layer instanceof L.Control.Search.Marker) return;

        if (layer instanceof L.Marker || layer instanceof L.CircleMarker) {
          if (that._getPath(layer.options, propName)) {
            loc = layer.getLatLng();
            loc.layer = layer;
            retRecords[that._getPath(layer.options, propName)] = loc;
          } else if (that._getPath(layer.feature.properties, propName)) {
            loc = layer.getLatLng();
            loc.layer = layer;
            retRecords[that._getPath(layer.feature.properties, propName)] = loc;
          } else
            throw new Error("propertyName '" + propName + "' not found in marker");
        } else if (layer.hasOwnProperty('feature')) //GeoJSON
        {
          if (layer.feature.properties.hasOwnProperty(propName)) {
            loc = layer.getBounds().getCenter();
            loc.layer = layer;
            retRecords[layer.feature.properties[propName]] = loc;
          } else
            throw new Error("propertyName '" + propName + "' not found in feature");
        } else if (layer instanceof L.LayerGroup) {
          layer.eachLayer(function(layer) {
            that._searchInLayer(layer, retRecords, propName);
          });
        }
      },

      _recordsFromLayer: function() { //return table: key,value from layer
        var that = this,
          retRecords = {},
          propName = this.options.propertyName;

        if (that._featuresToSearch.length > 0) {
            this._layer.eachLayer(function(layer) {
                for (var i = 0; i < that._featuresToSearch.length; i++) {
                    that._searchInLayer(layer, retRecords, that._featuresToSearch[i]);
                }
            });
        } else {
            this._layer.eachLayer(function(layer) {
                that._searchInLayer(layer, retRecords, propName);
            });
        }
        return retRecords;
      }
});
	
//Suchmaske mit angepassten Optionen festlegen
var searchControl = new L.Control.Search({
    layer: L.featureGroup([json_AlleJSON]),
			position: 'topleft', 
			featuresArray: ['Bez', 'Syn' /*'NAME', 'TELEFON' /*'Hkat', 'Nkat'*/ ],
			animateLocation: true,
			circleLocation: true,
			markerLocation: false,
			zoom: 12
});
		
//Festlegen was ausgeführt werden soll, wenn Suchvorgang erfolgreich war
searchControl.on('search_locationfound', function(e) {
	map.addOneTimeEventListener('moveend', function(){		
	sidebar.hide();
	json_AlleJSON.setStyle({fillColor: 'grey', color: 'black'});
	e.layer.setStyle({radius: 8.0, fillColor: '#EEC900', color: 'black', weight: 1.5});
	e.layer.bringToFront();
	removeButton._container.style.display = "Block";
	});
});
map.addControl(searchControl);
	
	
//Reset-Button der feature-Anzeige einfügen
var removeButton = L.easyButton({
	id: 'remove', 
	type: 'animate',
	position: 'topright',
	states: [{
			stateName: 'removePoints',
			icon:'fa fa-times',
			title: 'Punkte entfernen',
			onClick: function() {
					json_AlleJSON.setStyle({radius: 0.0000001, fillColor: 'grey', color: 'grey', weight: 0.000001});		
					searchControl._markerLoc.hide();
					removeButton._container.style.display = "none";
								}
	}]
});
removeButton.addTo(map);
removeButton._container.style.display = "none";

	
				
//Standortabfrage implementieren
L.control.locate({
    strings: {
        title: "Standort anzeigen"
			 },	
	locateOptions: {
        timeout: 20000}																				//Default-Wert von Leaflet = 10000   
	}).
	addTo(map);

//Routing-Funktion implementieren
//Zunächst Schaltfläche zur Freigabe der Vehicle einrichten
var routingButton = L.easyButton({
	id: 'routing', 
	type: 'animate',
	states: [{
			stateName: 'add-routing',
			icon:'fa-location-arrow',
			title: 'Routing hinzufügen',
			onClick: function() {
						var alerted1 = localStorage.getItem('alerted1') || '';
							if (alerted1 != 'yes') {
							alert("Hinweis: Ziehe die beiden Markierungen an Dein Start- und Zielpunkt. Wähle mittels angezeigter Schaltflächen anschließend dein bevorzugtes Reisemittel aus");
							localStorage.setItem('alerted1','yes');
							};
							
						map.setView([51.44480, 7.26150],15);
						routingButtonWalk.addTo(map);
						routingButtonCar.addTo(map);
						controlRouting.addTo(map);
						
						this.state('remove-routing');
						routingButtonWalk.state('add-routingWalk');
						routingButtonCar.state('add-routingCar');
								}
			}, {
			stateName: 'remove-routing',
			title: 'Routing schließen',
			icon: 'fa-location-arrow',
			onClick: function() {
						routingButtonWalk.remove();
						routingButtonCar.remove();
						map.removeControl(controlRouting);
						controlRouting.getRouter().options.costing = "";
						
						this.state('add-routing');
								}
				}
			]
}).addTo(map);

//Schaltfläche des Routings zu Fuß implementieren
var routingButtonWalk = L.easyButton({
	id: 'routing-walk', 
	type: 'animate',
	states: [{
			stateName: 'add-routingWalk',
			icon:'fa fa-male',
			title: 'zu Fuß',
			onClick: function() {
						var alerted = localStorage.getItem('alerted') || '';
							if (alerted != 'yes') {
							alert("Hinweis: Falls keine Route angezeigt wird, konnte keine Verbindung ermittelt werden!");
							localStorage.setItem('alerted','yes');
													  };
													  
						controlRouting.getRouter().options.costing = "pedestrian";
						controlRouting.route();
							
						this.state('remove-routingWalk');
						routingButtonCar.state('add-routingCar');
							   }				
			}, {
		stateName: 'remove-routingWalk',
		title: 'Routing zu Fuß',
		icon: 'fa fa-male',
		onClick: function() {
						map.removeControl(controlRouting);
						controlRouting.getRouter().options.costing = "";
						controlRouting.addTo(map);
						
						this.state('add-routingWalk');
						    }
			  }
			 ]
});

//Schaltfläche des Routings zu Fuß implementieren
var routingButtonCar = L.easyButton({
	id: 'routing-car',
	type: 'animate',
	states: [{
			stateName: 'add-routingCar',
			icon:'fa fa-car',
			title: 'Routing per Auto',
			onClick: function(){
						var alerted = localStorage.getItem('alerted') || '';
							if (alerted != 'yes') {
							alert("Hinweis: Falls keine Route angezeigt wird, konnte keine Verbindung ermittelt werden!");
							localStorage.setItem('alerted','yes');
												  };
	
						controlRouting.getRouter().options.costing = "auto";
						controlRouting.route();

						this.state('remove-routingCar');
						routingButtonWalk.state('add-routingWalk');
							  }
			}, {
	stateName: 'remove-routingCar',
		title: 'Routing schließen',
		icon: 'fa fa-car',
		onClick: function() {
					map.removeControl(controlRouting);
					controlRouting.getRouter().options.costing = "";
					controlRouting.addTo(map);
					
					this.state('add-routingCar');
				    }
			   }	
			]
});
	
	
//ImageOverlay zur Einbettung der SVG-Campuskarte einrichten	
var point1 = L.latLng(51.446, 7.2525),
	point2 = L.latLng(51.45034, 7.26549),
	point3 = L.latLng(51.44021, 7.25749);
			

var overlay = L.imageOverlay.rotated("Campusplan.svg", point1, point2, point3, {
			opacity: 1,
			interactive: false,
			attribution: "RUB-Campusplan &copy; <a href='https://www.geographie.ruhr-uni-bochum.de/institut/'>AG Geomatik | Geographisches Institut</a>"
});
		
map.addLayer(overlay);
		

function setOverlayOpacity(opacity) {
		overlay.setOpacity(opacity);
};
		

//Sidebar und mapOverlay-Control
sidebar.on('show', function () {
	map.removeControl(myControl);
});
		
sidebar.on('hidden', function () {
	map.addControl(myControl);
});
		
		
		
//Ausrichtung des Smartphones identifizieren und Funktion an Ausirchtung anpassen
window.addEventListener('orientationchange', doOnOrientationChange);

function doOnOrientationChange()
	{
		if (screen.height > screen.width) {
			myControl.setPosition('bottomleft');
			controlRouting._container.style.display = "none";
		
			} else {

				myControl.setPosition('bottomright');
		
				controlRouting._container.style.display = "Block";
		 
		if (controlRouting._container.style.display = "Block")
		{
		searchControl.collapse();
	
		}

				  }	
		
	}
	
	
    </script>

</body>
</html>