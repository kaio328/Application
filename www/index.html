<!DOCTYPE html>
<html>
    <head>
        <title>POI-Suche in Bochum</title>
    
        <meta charset="utf-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"  />
		<meta name="mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-capable" content="yes">
		
		<script src="js/leaflet1.0.2.js"></script>
		<script src="js/deps.js"></script>
		<script src="js/leaflet-include.js"></script>

        <script src="js/label.js"></script>
        <script src="js/Autolinker.min.js"></script>
		<script src="js/easy-button.js"></script>
		<script src="js/Control.Loading.js"></script>
	
		

		<link rel="stylesheet" href="font-awesome-4.7.0/css/font-awesome.min.css" />
        <link rel="stylesheet" href="css/leaflet1.0.2.css" />
        <link rel="stylesheet" type="text/css" href="css/qgis2web.css">
        <link rel="stylesheet" href="css/label.css" />

		<link rel="stylesheet" href="css/easy-button.css" />
		<link rel="stylesheet" href="css/leaflet-gps.css" />
		<link rel="stylesheet" href="css/Control.Loading.css" />
		<link rel="stylesheet" href="css/L.Control.Locate.css" />
		<link rel="stylesheet" href="css/mobile.css" />
		<link rel="stylesheet" href="css/L.Control.Sidebar.css" />
		<link rel="stylesheet" href="css/leaflet-gps.css" />
		<link rel="stylesheet" href="css/divicon.csss" />
		
		
    </head>
	    <style>
        body {
            padding: 0;
            margin: 0;
        }

        html, body, #map {
            height: 100%;
			background: #888888;
        }

        .lorem {
            font-style: calibri;
            color: red;
        }
		
		 #sidebar {		
			font-style: arial;
         
        }
	
    </style>
	
	
    <body>
	    <div id="sidebar">
        <h1>Informationen</h1>

        <p></p>

        <p><b></b></p>

        <p></p>

        <ul>
            <li><a href=></a></li>
            <li><a href=></a></li>
        </ul>

        <p class="lorem">Test</p>

        <p class="lorem">123</p>

        <p class="lorem">Sahira</p>

        <p class="lorem">Kai</p>
    </div>
	
        <div id="map"></div>
        <script src="data/json_Alle.js"></script>
		<script src="data/polygon9.js"></script>
		<script src="data/rahmen1.js"></script>
        <script src="data/sperrungen3.js"></script>
        <script src="data/treppen4.js"></script>
        <script src="data/weitereBauten5.js"></script>
        <script src="data/gewaesser6.js"></script>
        <script src="data/ubergange7.js"></script>
        <script src="data/grunflaechen8.js"></script>
        <script src="data/polygon9.js"></script>
        <script src="data/wege10.js"></script>
        <script src="data/strassen11.js"></script>
        <script src="data/parken12.js"></script>
        <script src="data/audimax13.js"></script>

		
		<script src="js/leaflet-search.js"></script>
		<script src="js/easy-button.js"></script>
		<script src="js/leaflet-gps.js"></script>
		<script src="js/L.Control.Locate.js" ></script>
		<script src="js/L.Control.Sidebar.js"></script>
		
		<link rel="stylesheet" href="css/leaflet-search.css" />	
		<link rel="stylesheet" href="css/easy-button.css" />

        <script>
		
		//Einrichtung der maxBounds
		var southWest = L.latLng(51.4566, 7.26);
		var northEast = L.latLng(51.4355, 7.27);
		
		//Einrichtung der Basiskarte
		var osmUrl = 'http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
			osmAttrib = '&copy; <a href="http://openstreetmap.org/copyright">OpenStreetMap</a> contributors',
			osm = L.tileLayer(osmUrl, {maxZoom: 18, minZoom: 15, opacity:1});
			
		//Einrichtung der Karte
		var map = L.map('map', {zoomControl: false, rotate: true, touchRotate: false})
				.setView([51.44459561, 7.26093000], 18);
				//.addLayer(osm)
				
		//Drehung der Karte um Winkel x		
		var angle = 27.825;
		map.setBearing(angle);	
		
		//Einrichtung der Campuskarte
		var CampusMapLinear = L.tileLayer('result2/{z}/{x}/{y}.png',{
		maxZoom: 18,
		minZoom: 15,
		}).addTo(map);
		
		CampusMapNN = L.tileLayer('result/{z}/{x}/{y}.png',{
		maxZoom: 18,
		minZoom: 15,
		}).addTo(map);
		
		//Einrichtung einer LayerGroup --> für mapOverlays
		var polygone = new L.layerGroup();
		
		//mapOverlays implementieren
		var overlayMaps = {
		"osm": osm,
		"CampusMapNN": CampusMapNN,
		"CampusMapLinear": CampusMapLinear,
		"polygone": polygone
		};
		
		//mapOverlays der Karte hinzufügen
		L.control.layers(null, overlayMaps).addTo(map);

//-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------	
		//Simples Imageoverlay einfügen
		//var imageUrl = 'Campusplan_roh.png',
		//imageBounds = [[51.4566, 7.26], [51.4355, 7.27]];

		//L.imageOverlay(imageUrl, imageBounds).addTo(map);

		//Sidebar einrichten
	   var sidebar = L.control.sidebar('sidebar', {
            closeButton: true,
            position: 'right'
        });
        map.addControl(sidebar);
		sidebar.hide();
		
		//Einrichtung des Loaders/Spinners
		var loadingControl = L.Control.loading({
                    separate: true																	//nicht angedockt am Zoom-Button
                });			
                map.addControl(loadingControl); 
				
				
		//Maßstab einfügen
		L.control.scale({options: {position: 'bottomleft',maxWidth: 100,metric: true,imperial: false,updateWhenIdle: false}}).addTo(map);
//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------	
		--> Kann entfernt werden?
		
		//Feature-/Layergroups einrichten
        var feature_group = new L.featureGroup([]);
        var bounds_group = new L.featureGroup([]);
        var raster_group = new L.LayerGroup([]);
	
		//Anordnung der Layer (?)
        var layerOrder = new Array();
        function restackLayers() {
            for (index = 0; index < layerOrder.length; index++) {
                layerOrder[index].bringToFront();
            }
        }
        map.on('overlayadd', restackLayers);
        layerControl = L.control.layers({},{},{collapsed:false});
//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------	
		
		//PopUp-Inhalt definieren (=popupContent), an sidebar übergeben, die per click auf ein feature geöffnet wird
		//Zur Aktualisierung wird side beim click auf ein weiteres feature zuerst geschlossen und anschließend wieder geöffnet (=Aktualisierung des sidebar-Inhaltes)
        function pop_Alle(feature, layer) {
		
		 layer.on('click', function (e) {
			layer.bringToFront();
			json_AlleJSON.setStyle({fillColor: 'grey', color: 'black'});
			layer.setStyle({radius: 8.0, fillColor: 'red', color: 'black', weight: 1.5});
			//layer.setRadius(15);			
			var sidebarContent = '<table><tr><th scope="row">BEZ</th><td>' + Autolinker.link(String(feature.properties['BEZ'])) + '</td></tr><tr><th scope="row">NAME</th><td>' + Autolinker.link(String(feature.properties['NAME'])) + '</td></tr><tr><th scope="row">TELEFON</th><td>' + Autolinker.link(String(feature.properties['TELEFON'])) + '</td></tr><tr><th scope="row">OEFFNUNG</th><td>' + Autolinker.link(String(feature.properties['OEFFNUNG'])) + '</td></tr><tr><th scope="row">WWW</th><td>' + Autolinker.link(String(feature.properties['WWW'])) + '</td></tr><tr><th scope="row">EMAIL</th><td>' + Autolinker.link(String(feature.properties['EMAIL'])) + '</td></tr><tr><th scope="row">STRASSE</th><td>' + Autolinker.link(String(feature.properties['STRASSE'])) + '</td></tr><tr><th scope="row">ORT</th><td>' + Autolinker.link(String(feature.properties['ORT'])) + '</td></tr><tr><th scope="row">BEMERKUNG</th><td>' + Autolinker.link(String(feature.properties['BEMERKUNG'])) + '</td></tr><tr><th scope="row">PLZ</th><td>' + Autolinker.link(String(feature.properties['PLZ'])) + '</td></tr><tr><th scope="row">Hkat</th><td>' + Autolinker.link(String(feature.properties['Hkat'])) + '</td></tr><tr><th scope="row">Nkat</th><td>' + Autolinker.link(String(feature.properties['Nkat'])) + '</td></tr></table>' + '<table><tr><th scope="row"></th><td>' + '';

			document.getElementById("sidebar").innerHTML = sidebarContent;						//Sidebar-Inhalt zuweisen --> Properties des geclickten features
			//document.getElementById("sidebar").style.fontSize = "15px";						//Sidebar-Schriftgröße ändern
			sidebar.show();
        })};
		


        //Style der Punktsignaturen, die die features des Layers (in dem Fall Alle_json) abbilden -->  Farbe, Radius, Transperanz der Kreise etc.
		function doStyleAlle() {
            return {
                radius: 0.0,
                fillColor: 'grey',
                color: 'black',
                weight: 0.0,
                opacity: 1,
                dashArray: '',
                fillOpacity: 1
	
            }
        };
		
		//Funktion mit der Features des Layers auf Basis des festlegeten Styles (doStyleAlle) abbgebilded werden
        function doPointToLayerAlle(feature, latlng) {
            return L.circleMarker(latlng, doStyleAlle())
        };
	
		//Einbindung der Datei json_AlleJSON als Layer
		var json_AlleJSON = new L.geoJson(json_Alle, {
			onEachFeature: pop_Alle,													//für jedes feature wird die function pop_Alle ausgeführt
			pointToLayer: doPointToLayerAlle											//features werden mittels function doPointToLayerAlle und dem darin enhaltenen Verweis auf doStyleAlle als Punkt-Signatures abgebildet
		});	
	 

	  //Style festlegen, der für Polygone genutzt wird
		var stylePolygone = {
		"color":  'rgb(7, 48, 87)',
		"weight": 1,
		"opacity": 0.65,
		"fillOpacity": 1
		};
		var styleGrunflaechen = {
		"color": 'rgb(212, 238, 189)',			//"#d4eebdff"
		"weight": 1,
		"opacity": 0.65,
		"fillOpacity": 1
		};
		var styleParken = {
		"color": 'rgb(215, 209, 207)',		//"d7d1cfff"
		"weight": 1,
		"opacity": 0.65,
		"fillOpacity": 1
		};
		var styleRahmen = {
		"color": 'rgb(209, 204, 222)',
		"weight": 0,
		"opacity": 1,
		"fillOpacity": 1
		};
		var styleSperrungen = {
		"color": "#000000ff",
		"weight": 1,
		"opacity": 0.65,
		"fillOpacity": 1
		};
		var styleTreppe = {
		"color": "#000000ff",
		"weight": 1,
		"opacity": 0.65,
		"fillOpacity": 1
		};
		var styleUbergange = {
		"color": 'rgb(74, 102, 145)',		//"#4a6691ff",
		"weight": 1,
		"opacity": 0.65,
		"fillOpacity": 1
		};
		
		//add Polygone
		json_rahmenJSON = new L.geoJson(json_rahmen1, {interactive: false, style: styleRahmen}).addTo(polygone);
		json_grunflaechenJSON = new L.geoJson(json_grunflaechen8, {interactive: false, style: styleGrunflaechen}).addTo(polygone);
		json_parkenJSON = new L.geoJson(json_parken12, {interactive: false, style: styleParken}).addTo(polygone);
		json_ubergangeJSON = new L.geoJson(json_ubergange7, {interactive: false, style: styleUbergange}).addTo(polygone);
		json_polygonJSON = new L.geoJson(json_polygon9, {interactive: false, style: stylePolygone}).addTo(polygone);
		json_treppeJSON = new L.geoJson(json_treppen4, {interactive: false, style: styleTreppe}).addTo(polygone);
		json_sperrungenJSON = new L.geoJson(json_sperrungen3, {interactive: false, style: styleSperrungen}).addTo(polygone);
		

var smallIcon2 = new L.Icon({
    iconUrl: 'css/images/marker-icon.png',
    iconRetinaUrl: 'css/images/marker-icon-2x.png',
    iconSize:    [25, 41],
    iconAnchor:  [12, 41],
    popupAnchor: [1, -34],
    shadowUrl: 'css/images/marker-shadow.png',
    shadowSize:  [41, 41]
});


var iconUB = new L.divIcon({
	className: 'leaflet-div-icon',
	iconSize:    [0, 0],
	html: '<b><FONTSIZE="88">UB</FONT></b>'
	});

var iconHZO = new L.divIcon({
	className: 'leaflet-div-icon',
	iconSize:    [0, 0],
	html: '<b><FONTSIZE="88">HZO</FONT></b>'
	});
	
var UB = L.marker([51.44503, 7.26062], {icon: iconUB});
var HZO = L.marker([51.44478, 7.26243], {icon: iconHZO});
	
var Text = new L.layerGroup([]);
Text.addLayer(UB);


var visible;
// Attach map zoom handler
map.on('zoomend', function (e) {
    // Check zoom level
    if (map.getZoom() > 16) {
        // Check if not already shown
        if (!visible) {
		map.addLayer(Text);
            };
            // Set visibility flag
            visible = true;
        
    } else {
        // Check if not already hidden
        if (visible) {
            // Loop over layers
			map.removeLayer(Text);
            };
            // Set visibility flag
            visible = false;
        }
    
});
map.fitBounds(json_rahmenJSON.getBounds());


var marker = L.marker([51.44459561, 7.26093000], {
icon: smallIcon2,
draggable: true
}).addTo(map);
marker.bindPopup("Test");
marker.on('click', function(e) {
marker.getPopup().setContent('Clicked' + marker.getLatLng().toString()).openOn(map);
});
		
		
		//Watermark
		
		/*L.Control.Watermark = L.Control.extend({
		onAdd: function(map) {
        var img = L.DomUtil.create('img');

        img.src = 'rub.jpg';
        img.style.width = '500px';
		img.style.margintop = '400px';

        return img;
    },

    onRemove: function(map) {
        // Nothing to do here
    }
});

L.control.watermark = function(opts) {
    return new L.Control.Watermark(opts);
}

L.control.watermark({ position: 'bottomleft' }).addTo(map);*/


		
		
		//Einrichtung der Suchmaske
		//Zunächst Möglichkeit schaffen, nach mehreren Attributen zu suchen
		L.Control.Search.include({
		_searchInLayer: function(layer, retRecords, propName) {
			var that = this,
          loc;

		if (layer instanceof L.Control.Search.Marker) return;

        if (layer instanceof L.Marker || layer instanceof L.CircleMarker) {
          if (that._getPath(layer.options, propName)) {
            loc = layer.getLatLng();
            loc.layer = layer;
            retRecords[that._getPath(layer.options, propName)] = loc;
          } else if (that._getPath(layer.feature.properties, propName)) {
            loc = layer.getLatLng();
            loc.layer = layer;
            retRecords[that._getPath(layer.feature.properties, propName)] = loc;
          } else
            throw new Error("propertyName '" + propName + "' not found in marker");
        } else if (layer.hasOwnProperty('feature')) //GeoJSON
        {
          if (layer.feature.properties.hasOwnProperty(propName)) {
            loc = layer.getBounds().getCenter();
            loc.layer = layer;
            retRecords[layer.feature.properties[propName]] = loc;
          } else
            throw new Error("propertyName '" + propName + "' not found in feature");
        } else if (layer instanceof L.LayerGroup) {
          layer.eachLayer(function(layer) {
            that._searchInLayer(layer, retRecords, propName);
          });
        }
      },

      _recordsFromLayer: function() { //return table: key,value from layer
        var that = this,
          retRecords = {},
          propName = this.options.propertyName;

        if (that._featuresToSearch.length > 0) {
            this._layer.eachLayer(function(layer) {
                for (var i = 0; i < that._featuresToSearch.length; i++) {
                    that._searchInLayer(layer, retRecords, that._featuresToSearch[i]);
                }
            });
        } else {
            this._layer.eachLayer(function(layer) {
                that._searchInLayer(layer, retRecords, propName);
            });
        }
        return retRecords;
      }
    });
	
	//Suche mit angepassten Optionen festlegen
    var searchControl = new L.Control.Search({
        layer: L.featureGroup([json_AlleJSON]),
        //propertyName: 'Nkat',
        position: 'topleft', 
		featuresArray: ['Bez', 'Syn' /*'NAME', 'TELEFON' /*'Hkat', 'Nkat'*/ ],
		animateLocation: true,
        circleLocation: true,
		markerLocation: false,
		zoom: 12});
		
	//Festlegen was ausgeführt werden soll, wenn Suche erfolgreich war
	searchControl.on('search_locationfound', function(e) {
	sidebar.hide();
	json_AlleJSON.setStyle({fillColor: 'grey', color: 'black'});
	e.layer.setStyle({radius: 8.0, fillColor: 'red', color: 'black', weight: 1.5});
	e.layer.bringToFront();
	});
	map.addControl(searchControl);
	
//-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------				
	
	//Button für Standortsuche und gleichnamiger Funktion implementieren
	L.control.locate({
    strings: {
        title: "Standort anzeigen"
    },	
	locateOptions: {
               timeout: 10000}														//ist auch der Default-Wert von Leaflet	   
	}).addTo(map);

	//Reset-Button einfügen
	L.easyButton('fa fa-times', function(layer){
	json_AlleJSON.setStyle({radius: 0.0000001, fillColor: 'grey', color: 'grey', weight: 0.000001});	//Style und Radius resetten
	sidebar.hide();																	//sidebar schließen
	//map._layers.removeLayer(that._markerLoc);														 		//MarkerLocation entfernen
	}).addTo(map);
	
    </script>

</body>
</html>